<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

        <!-- Basic Page Needs
================================================== -->
        <meta charset="utf-8">
  <title>hascallstack-domain-errors</title>
        <meta name="description" content>
        <meta name="author" content>

        <!-- Fonts
================================================== -->
  <link href="http://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet" type="text/css">

        <!-- Mobile Specific Metas
================================================== -->
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- CSS
================================================== -->
  <link rel="stylesheet" href="../../css/combined.css">

  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

        <!--[if lt IE 9]>
                <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <!-- Atom
        ================================================== -->
</head>
<body>

        <!-- Primary Page Layout
        ================================================== -->
  <div class="container">
  <div class="ten columns offset-by-three">
  <h1 style="margin-top: 40px"><a class="homelink" href="../../">The H2 Wiki</a></h1>
  <hr />
</div>
<div class="twelve columns offset-by-two">
  <h3>hascallstack-domain-errors</h3>
  <h1 id="domain-errors-with-hascallstack">Domain errors with <code>HasCallStack</code></h1>
<h2 id="introduction">Introduction</h2>
<p><a href="https://www.stackage.org/haddock/lts-22.43/base-4.18.2.1/GHC-Stack.html#t:HasCallStack"><code>HasCallStack</code></a>
is a feature in Haskell’s compiler, GHC, that is frequently used to
annotate exceptions with the call stack at the point in the program
from which they were thrown. For example, I can define an exception
type that, as well as a message, contains a <code>CallStack</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">MyException</span> <span class="ot">=</span> <span class="dt">MkMyException</span> <span class="dt">String</span> <span class="dt">CallStack</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Exception</span> <span class="dt">MyException</span></span></code></pre></div>
<p>And define a way of creating it that captures the current call stack:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">mkMyException ::</span> <span class="dt">HasCallStack</span> <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">MyException</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mkMyException msg <span class="ot">=</span> <span class="dt">MkMyException</span> msg callStack</span></code></pre></div>
<p>Then when I catch the exception I can inspect the call stack:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">myExceptionExample ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>myExceptionExample <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  Control.Exception.catch <span class="op">@</span><span class="dt">MyException</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    (throwIO (mkMyException <span class="st">&quot;Hello&quot;</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    (\(<span class="dt">MkMyException</span> msg cs) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">putStrLn</span> msg</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">putStrLn</span> <span class="st">&quot;Thrown from:&quot;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">putStrLn</span> (prettyCallStack cs))</span></code></pre></div>
<pre><code>ghci&gt; myExceptionExamplea
Hello
Thrown from:
CallStack (from HasCallStack):
  mkMyException, called at code/hascallstack-domain-2.hs:28:15 in fake-package-0-inplace:HD2</code></pre>
<p>The feature makes debugging easier by allowing the origin of of an
exception to be discovered. But it is useful for more than just
exceptions: it is also useful for error messages in domain specific
languages. In this article we’ll look at an example of such a use
case.</p>
<h2 id="an-assembly-edsl">An assembly EDSL</h2>
<p>At <a href="https://groq.com/">Groq</a>, one of the things we use Haskell for is
to provide an embedded domain specific assembly language (an “assembly
EDSL”) for our novel chip, the “LPU”.</p>
<p>The assembly language allows us to define a program, which consists of
a sequence of instructions to run on each processor on the chip and a
collection of data values (called “constants”) that are loaded
alongside the program to particular addresses in the chip’s memory.</p>
<p>Let’s have a look at how we can implement part of this in Haskell,
restricting ourselves, for simplicity, to specifying the constant
values and addresses. For the purposes of this article, we’ll say
that a memory address (<code>Address</code>) is an <code>Int</code>, and a constant value
placed at an address (<code>Data</code>) is a list of <code>Word8</code> of length 8 (i.e. a
list of 8 bytes). In practice we would probably use newtype or data
definitions but to keep things simple in this article we’ll just use
type synonyms.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Address</span> <span class="ot">=</span> <span class="dt">Int</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should be length 8.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- We'll check that elsewhere.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Data</span> <span class="ot">=</span> [<span class="dt">Word8</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- A &quot;constant&quot; is some data residing at</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- a particular address</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Constant</span> <span class="ot">=</span> <span class="dt">MkConstant</span> <span class="dt">Address</span> <span class="dt">Data</span></span></code></pre></div>
<p>We want to be able to define constants using a convenient syntax, for
example like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">example ::</span> <span class="dt">Assembly</span> ()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>example <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Place bytes 0x00 to 0x07 at address 0x0000</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0000</span> [<span class="bn">0x00</span> <span class="op">..</span> <span class="bn">0x07</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Place bytes 0x10 to 0x17 at address 0x0001</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0001</span> [<span class="bn">0x10</span> <span class="op">..</span> <span class="bn">0x17</span>]</span></code></pre></div>
<p>Let’s see how we can arrange that. Firstly, we’ll need an <code>Assembly</code>
monad. Here I’m using Bluefin for the implementation. The
implementation is roughly equivalent to a <code>Writer [Constant]</code> monad
(from the <code>transformers</code> library) or a <code>Stream (Of Constant)</code> monad
(from the <code>streaming</code> library). (For the monad instance, see the
<a href="#appendix">appendix</a>.)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Assembly</span> a</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">MkAssembly</span> (<span class="kw">forall</span> es<span class="op">.</span> <span class="dt">Stream</span> <span class="dt">Constant</span> es <span class="ot">-&gt;</span> <span class="dt">Eff</span> es a)</span></code></pre></div>
<p>Then what should the function <code>constant</code> do? It should yield the
arguments we give it into the stream, so that when we run the stream
we pick them up.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">constant ::</span> <span class="dt">Address</span> <span class="ot">-&gt;</span> <span class="dt">Data</span> <span class="ot">-&gt;</span> <span class="dt">Assembly</span> ()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>constant addr data_ <span class="ot">=</span> <span class="dt">MkAssembly</span> <span class="op">$</span> \c <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  yield c (<span class="dt">MkConstant</span> addr data_)</span></code></pre></div>
<p>For the assembly stage, let’s collect the constants together and put
them in a <code>Map</code> (from the <code>containers</code> library) keyed by <code>Address</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">AssembledProgram</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">MkAssembledProgram</span> (<span class="dt">Map</span> <span class="dt">Address</span> <span class="dt">Data</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ot">assemble ::</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Assembly</span> () <span class="ot">-&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Eff</span> es <span class="dt">AssembledProgram</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>assemble (<span class="dt">MkAssembly</span> k) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  (constants, ()) <span class="ot">&lt;-</span> yieldToList <span class="op">$</span> \ct <span class="ot">-&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    forEach (useImpl <span class="op">.</span> k) <span class="op">$</span> \(<span class="dt">MkConstant</span> addr data_) <span class="ot">-&gt;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>      yield ct (addr, data_)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> m <span class="ot">=</span> Map.fromList constants</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> (<span class="dt">MkAssembledProgram</span> m)</span></code></pre></div>
<p>And to see the output of <code>assemble</code> we write <code>showAssemble</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">showAssemble ::</span> <span class="dt">Assembly</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>showAssemble a <span class="ot">=</span> runEff <span class="op">$</span> \io <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  ap <span class="ot">&lt;-</span> assemble a</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  effIO io (<span class="fu">print</span> ap)</span></code></pre></div>
<pre><code>&gt; showAssemble example
MkAssembledProgram (fromList [(0,[0,1,2,3,4,5,6,7]),(1,[16,17,18,19,20,21,22,23])])</code></pre>
<p>That was what we hoped for! Our original <code>example</code> above had two
constants, on addresses <code>0x0000</code> and <code>0x0001</code>, exactly as the result
shows. Unfortunately the situation is less good on badly-behaved
examples: for example, if the number of bytes we provide is incorrect,
then the error just passes silently. We get invalid-length lists in
the output:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">badExampleLength ::</span> <span class="dt">Assembly</span> ()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>badExampleLength <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Oh dear, this list is too short.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- It's only length 4 but should be 8.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0000</span> [<span class="bn">0x00</span> <span class="op">..</span> <span class="bn">0x04</span>]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0001</span> [<span class="bn">0x10</span> <span class="op">..</span> <span class="bn">0x17</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- And this one is too short too.</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0002</span> [<span class="bn">0x00</span> <span class="op">..</span> <span class="bn">0x04</span>]</span></code></pre></div>
<pre><code>&gt; showAssemble badExampleLength
MkAssembledProgram (fromList [(0,[0,1,2,3,4]),(1,[16,17,18,19,20,21,22,23]),(2,[0,1,2,3,4])])</code></pre>
<p>Or if we specify two constants at the same address then one of them is
silently dropped:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ot">badExampleDuplication ::</span> <span class="dt">Assembly</span> ()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>badExampleDuplication <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0000</span> [<span class="bn">0x00</span> <span class="op">..</span> <span class="bn">0x07</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0001</span> [<span class="bn">0x10</span> <span class="op">..</span> <span class="bn">0x17</span>]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- Oh dear, this is at the same</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- address as another constant</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  constant <span class="bn">0x0000</span> [<span class="bn">0x10</span> <span class="op">..</span> <span class="bn">0x17</span>]</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> showAssemble badExampleDuplication</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dt">MkAssembledProgram</span> (fromList [(<span class="dv">0</span>,[<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">19</span>,<span class="dv">20</span>,<span class="dv">21</span>,<span class="dv">22</span>,<span class="dv">23</span>]),(<span class="dv">1</span>,[<span class="dv">16</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">19</span>,<span class="dv">20</span>,<span class="dv">21</span>,<span class="dv">22</span>,<span class="dv">23</span>])])</span></code></pre></div>
<h2 id="throwing-an-exception">Throwing an exception</h2>
<p>Let’s tackle the incorrect size issue first. We can amend <code>constant</code>
to throw an exception when the list provided has the wrong length.
Using <code>HasCallStack</code> we can helpfully include the location of the call
to <code>constant</code> which had an erroneous argument.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">constant ::</span> (<span class="dt">HasCallStack</span>) <span class="ot">=&gt;</span> <span class="dt">Address</span> <span class="ot">-&gt;</span> <span class="dt">Data</span> <span class="ot">-&gt;</span> <span class="dt">Assembly</span> ()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>constant addr data_ <span class="ot">=</span> <span class="dt">MkAssembly</span> <span class="op">$</span> \c <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> l <span class="ot">=</span> <span class="fu">length</span> data_</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  when (l <span class="op">/=</span> <span class="dv">8</span>) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> cs <span class="ot">=</span> callStack</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span> <span class="op">$</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlines</span> <span class="op">$</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;Wrong size constant&quot;</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;Expected: 8&quot;</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;Actual: &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> l,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;In:&quot;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> showCallStack cs</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  yield c (<span class="dt">MkConstant</span> addr data_)</span></code></pre></div>
<p>Then we can catch the exception thrown by <code>error</code> when we come to
print out the result of the assembly.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">showAssemble ::</span> <span class="dt">Assembly</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>showAssemble a <span class="ot">=</span> runEff <span class="op">$</span> \io <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  handle</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    (effIO io <span class="op">.</span> <span class="fu">putStrLn</span> <span class="op">.</span> (\(<span class="dt">ErrorCall</span> s) <span class="ot">-&gt;</span> s))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    ( \ex <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        rethrowIO io ex <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>          ap <span class="ot">&lt;-</span> assemble a</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>          effIO io (<span class="fu">print</span> ap)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<pre><code>&gt; showAssemble badExampleLength
Wrong size constant
Expected: 8
Actual: 5
In:
constant at 92:3</code></pre>
<p>That works! We see the line and column number of one of the mis-sized
constants. But there are still two problems. Firstly, we can only
catch the <code>ErrorCall</code> thrown by <code>error</code> where we have access to <code>IO</code>.
Ideally we’d like to catch it in <code>showAssemble</code>, but we don’t want
that function to use <code>IO</code>. Secondly, there were two constants with
incorrect sizes, and when we ran <code>error</code> in <code>constant</code> it stopped
processing then and there, so we didn’t get to pick up the other one.
What can we do?</p>
<h2 id="annotate-with-the-callstack">Annotate with the <code>CallStack</code></h2>
<p>Instead of throwing an exception annotated with the <code>CallStack</code> we can
annotate our constants with the <code>CallStack</code>. To do so we rewrite
<code>constant</code> to:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ot">constant ::</span> (<span class="dt">HasCallStack</span>) <span class="ot">=&gt;</span> <span class="dt">Address</span> <span class="ot">-&gt;</span> <span class="dt">Data</span> <span class="ot">-&gt;</span> <span class="dt">Assembly</span> ()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>constant addr data_ <span class="ot">=</span> <span class="dt">MkAssembly</span> <span class="op">$</span> \c <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  yield c (<span class="dt">MkConstant</span> callStack addr data_)</span></code></pre></div>
<p>Then we can move the check for mis-sized constants into <code>assemble</code>.
If we find any we throw an exception which mentions the source
locations of the definitions of <em>all</em> of them, not just one of them.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ot">assemble ::</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  (e <span class="op">:&gt;</span> es) <span class="ot">=&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Assembly</span> () <span class="ot">-&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Exception</span> <span class="dt">String</span> e <span class="ot">-&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Eff</span> es <span class="dt">AssembledProgram</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>assemble (<span class="dt">MkAssembly</span> k) ex <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  (constants, (errorLines, ())) <span class="ot">&lt;-</span> yieldToList <span class="op">$</span> \yconstant <span class="ot">-&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    yieldToList <span class="op">$</span> \yerror <span class="ot">-&gt;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>      forEach (useImpl <span class="op">.</span> k) <span class="op">$</span> \(<span class="dt">MkConstant</span> cs addr data_) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> l <span class="ot">=</span> <span class="fu">length</span> data_</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        yield yconstant (addr, data_)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- If the constant was the wrong length</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- yield some error message lines</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        when (l <span class="op">/=</span> <span class="dv">8</span>) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>          traverse_</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            (yield yerror)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            ( [ <span class="st">&quot;Wrong size constant&quot;</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Expected: 8&quot;</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Actual: &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> l,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;In:&quot;</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>              ]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;&gt;</span> showCallStack cs</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;&gt;</span> [<span class="st">&quot;&quot;</span>]</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- If there were any error lines, throw them</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> errorLines <span class="kw">of</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    [] <span class="ot">-&gt;</span> <span class="fu">pure</span> ()</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> throw ex (<span class="fu">unlines</span> errorLines)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- If not, gather the constants into a map</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> m <span class="ot">=</span> Map.fromList constants</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> (<span class="dt">MkAssembledProgram</span> m)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="ot">showAssemble ::</span> <span class="dt">Assembly</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>showAssemble a <span class="ot">=</span> runEff <span class="op">$</span> \io <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  handle (effIO io <span class="op">.</span> <span class="fu">putStr</span>) <span class="op">$</span> \ex <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    ap <span class="ot">&lt;-</span> assemble a ex</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    effIO io (<span class="fu">print</span> ap)</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> showAssemble badExampleLength</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Wrong</span> size constant</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Expected</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Actual</span><span class="op">:</span> <span class="dv">5</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="dt">In</span><span class="op">:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>constant at <span class="dv">101</span><span class="op">:</span><span class="dv">3</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="dt">Wrong</span> size constant</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="dt">Expected</span><span class="op">:</span> <span class="dv">8</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="dt">Actual</span><span class="op">:</span> <span class="dv">5</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="dt">In</span><span class="op">:</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>constant at <span class="dv">104</span><span class="op">:</span><span class="dv">3</span></span></code></pre></div>
<p>That works! We can see information about both of the mis-sized
constants.</p>
<h2 id="detecting-duplicates">Detecting duplicates</h2>
<p>We now have enough information in the body of <code>assemble</code> to present
the user with the source location of constants which share the same
address. To arrange that, we keep the first part of <code>assemble</code> almost
the same as before; in the second part we gather all constants for
each address into a non-empty list, and throw an exception if any such
list was more than one element long.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ot">assemble ::</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  (e <span class="op">:&gt;</span> es) <span class="ot">=&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Assembly</span> () <span class="ot">-&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Exception</span> <span class="dt">String</span> e <span class="ot">-&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Eff</span> es <span class="dt">AssembledProgram</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>assemble (<span class="dt">MkAssembly</span> k) ex <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- This part very similar to before</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  (constants, (errors, ())) <span class="ot">&lt;-</span> yieldToList <span class="op">$</span> \yconstant <span class="ot">-&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    yieldToList <span class="op">$</span> \yerror <span class="ot">-&gt;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      forEach (useImpl <span class="op">.</span> k) <span class="op">$</span> \(<span class="dt">MkConstant</span> cs addr data_) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> l <span class="ot">=</span> <span class="fu">length</span> data_</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- We put the call stack and data in a non-empty list</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- before yielding it.</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        yield yconstant (addr, <span class="fu">pure</span> (cs, data_))</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- If the constant was the wrong length</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- yield some error message lines</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        when (l <span class="op">/=</span> <span class="dv">8</span>) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>          traverse_</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>            (yield yerror)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>            ( [ <span class="st">&quot;Wrong size constant&quot;</span>,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Expected: 8&quot;</span>,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Actual: &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> l,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;In:&quot;</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>              ]</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;&gt;</span> showCallStack cs</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;&gt;</span> [<span class="st">&quot;&quot;</span>]</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- If there were any errors, throw them</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> errors <span class="kw">of</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    [] <span class="ot">-&gt;</span> <span class="fu">pure</span> ()</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> throw ex (<span class="fu">unlines</span> errors)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- This part is new, and detects duplicate constants</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- We gather all the values for a given key (address)</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- into a non-empty list.  If such a list has more than</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- one element, that indicates an error.</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span><span class="ot"> m ::</span> <span class="dt">Map</span> <span class="dt">Address</span> (<span class="dt">NonEmpty</span> (<span class="dt">CallStack</span>, <span class="dt">Data</span>))</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">=</span> Map.fromListWith (<span class="op">&lt;&gt;</span>) constants</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- For each address with a constant, check if there is</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- only one, or more than one, constant specified for</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- that address.</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>  m' <span class="ot">&lt;-</span> <span class="fu">flip</span> Map.traverseWithKey m <span class="op">$</span> \addr csData <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> csData <span class="kw">of</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- Only one constant at this address. That's fine.</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>      (_, data_) <span class="op">Data.List.NonEmpty.:|</span> [] <span class="ot">-&gt;</span> <span class="fu">pure</span> data_</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- Multiple constants at this address. Report the</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- error</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>      _ <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        throw ex <span class="op">$</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unlines</span> <span class="op">$</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>            [ <span class="st">&quot;Duplicate constants at address &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> addr</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>              <span class="op">&lt;&gt;</span> <span class="fu">concatMap</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>                (\(cs, _) <span class="ot">-&gt;</span> showCallStack cs)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>                (toList csData)</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> (<span class="dt">MkAssembledProgram</span> m')</span></code></pre></div>
<pre><code>&gt; showAssemble badExampleDuplication
Duplicate constants at address 0
constant at 123:3
constant at 121:3</code></pre>
<p>That works very nicely! We get to see the address with duplicated
constants, and the source locations where those constants were
defined. We could improve our implementation by throwing an exception
containing <em>all</em> addresses with duplicated constants (currently,
processing stops at the first such address), but we won’t bother to do
so in this article.</p>
<h2 id="conclusion">Conclusion</h2>
<p><code>HasCallStack</code> is useful not only for error messages arising from
exceptions, it can be helpful for a wider class of error messages. If
you capture a call stack alongside data you can display annotated
error messages when you detect error conditions during processing that
data.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.well-typed.com/blog/2024/12/debuggable/">Debugging your Haskell application with
debuggable</a>
shows many other uses to which you can put <code>HasCallStack</code>, including
tracing messages.</li>
</ul>
<h2 id="appendix">Appendix</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode .hs"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Functor</span> <span class="dt">Assembly</span> <span class="kw">where</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmap</span> f (<span class="dt">MkAssembly</span> g) <span class="ot">=</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">MkAssembly</span> (\s1 <span class="ot">-&gt;</span> <span class="fu">fmap</span> f (g s1))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Applicative</span> <span class="dt">Assembly</span> <span class="kw">where</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> x <span class="ot">=</span> <span class="dt">MkAssembly</span> (\_ <span class="ot">-&gt;</span> <span class="fu">pure</span> x)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">MkAssembly</span> f <span class="op">&lt;*&gt;</span> <span class="dt">MkAssembly</span> x <span class="ot">=</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">MkAssembly</span> (\s1 <span class="ot">-&gt;</span> f s1 <span class="op">&lt;*&gt;</span> x s1)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> <span class="dt">Assembly</span> <span class="kw">where</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="ot">=</span> <span class="fu">pure</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">MkAssembly</span> m <span class="op">&gt;&gt;=</span> f <span class="ot">=</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">MkAssembly</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>      ( \s1 <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>          a <span class="ot">&lt;-</span> m s1</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>          <span class="kw">case</span> f a <span class="kw">of</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">MkAssembly</span> f' <span class="ot">-&gt;</span> f' s1</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>      )</span></code></pre></div>
</div>
<hr>

  </div>

<!-- End Document
================================================== -->
</body>
</html>
